<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SchedulingAssistant.ViewModels.Management"
             xmlns:models="using:SchedulingAssistant.Models"
             x:Class="SchedulingAssistant.Views.Management.SectionListView"
             x:DataType="vm:SectionListViewModel"
             x:CompileBindings="False">

    <UserControl.Styles>
        <!-- Compact popup trigger button: looks like a bordered label, toggles popup open/closed -->
        <Style Selector="ToggleButton.EditorPopupTrigger">
            <Setter Property="Background" Value="{StaticResource FilterExpanderContent}" />
            <Setter Property="BorderBrush" Value="{StaticResource SubduedBorder}" />
            <Setter Property="BorderThickness" Value="1" />
            <Setter Property="Padding" Value="4,2" />
            <Setter Property="MinHeight" Value="0" />
            <Setter Property="MinWidth" Value="0" />
            <Setter Property="FontSize" Value="11" />
            <Setter Property="HorizontalAlignment" Value="Stretch" />
            <Setter Property="HorizontalContentAlignment" Value="Left" />
            <Setter Property="Foreground" Value="{StaticResource TextFaint}" />
            <Setter Property="TextBlock.TextTrimming" Value="CharacterEllipsis" />
        </Style>
        <Style Selector="ToggleButton.EditorPopupTrigger:pointerover">
            <Setter Property="Background" Value="{StaticResource ButtonHover}" />
        </Style>
        <Style Selector="ToggleButton.EditorPopupTrigger:checked">
            <Setter Property="Background" Value="{StaticResource FilterExpanderBorder}" />
        </Style>
    </UserControl.Styles>

   <UserControl.Resources>
        <!-- Shared template for the inline edit form, used for both Add and Edit -->
        <DataTemplate x:Key="InlineEditFormTemplate" DataType="{x:Type vm:SectionEditViewModel}">
            <StackPanel Spacing="4">

                <!-- Save / Cancel (top) -->
                <StackPanel Orientation="Horizontal" Spacing="6" Margin="0,0,0,2">
                    <Button Content="Save"   Command="{Binding SaveCommand}"   FontSize="10" Padding="6,2" />
                    <Button Content="Cancel" Command="{Binding CancelCommand}" FontSize="10" Padding="6,2" />
                </StackPanel>

                <!-- Subject + Course Number + Campus + Section Code + Section Type side by side -->
                <Grid ColumnDefinitions="100,80,Auto,80,90" Margin="0,0,0,0">
                    <!-- Subject dropdown -->
                    <StackPanel Grid.Column="0" Margin="0,0,4,0">
                        <TextBlock Text="Subject" FontSize="10" Foreground="{StaticResource TextLabel}" />
                        <ComboBox ItemsSource="{Binding Subjects}"
                                  SelectedItem="{Binding SelectedSubject}"
                                  DisplayMemberBinding="{Binding CalendarAbbreviation}"
                                  FontSize="11"
                                  HorizontalAlignment="Stretch" />
                    </StackPanel>

                    <!-- Course Number dropdown (filtered by subject) -->
                    <StackPanel Grid.Column="1" Margin="0,0,4,0">
                        <TextBlock Text="Course #" FontSize="10" Foreground="{StaticResource TextLabel}" />
                        <ComboBox ItemsSource="{Binding CourseNumbers}"
                                  SelectedItem="{Binding SelectedCourseNumber}"
                                  FontSize="11"
                                  HorizontalAlignment="Stretch"
                                  IsEnabled="{Binding HasAvailableCourseNumbers}" />
                    </StackPanel>

                    <!-- Campus dropdown (available for both new and edit) -->
                    <StackPanel Grid.Column="2" Margin="0,0,4,0"
                                IsEnabled="{Binding IsSectionCodeEnabled}">
                        <TextBlock Text="Campus" FontSize="10" Foreground="{StaticResource TextLabel}" />
                        <ComboBox ItemsSource="{Binding CampusOptions}"
                                  SelectedValueBinding="{Binding Value}"
                                  SelectedValue="{Binding SelectedCampus}"
                                  DisplayMemberBinding="{Binding Label}"
                                  FontSize="11" MinWidth="70"
                                  HorizontalAlignment="Stretch" />
                    </StackPanel>

                    <!-- Section Code -->
                    <StackPanel Grid.Column="3" Margin="0,0,4,0">
                        <TextBlock Text="Section Code" FontSize="10" Foreground="{StaticResource TextLabel}" />
                        <TextBox x:Name="SectionCodeBox"
                                 Text="{Binding SectionCode}"
                                 IsEnabled="{Binding IsSectionCodeEnabled}"
                                 FontSize="11" Height="24" />
                        <TextBlock Text="{Binding SectionCodeError}"
                                   IsVisible="{Binding SectionCodeError, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                   FontSize="9" Foreground="{StaticResource TextValidationError}" TextWrapping="Wrap" Margin="0,1,0,0" />
                    </StackPanel>

                    <!-- Section Type -->
                    <StackPanel Grid.Column="4" IsEnabled="{Binding AreOtherFieldsEnabled}">
                        <TextBlock Text="Section Type" FontSize="10" Foreground="{StaticResource TextLabel}" />
                        <ComboBox ItemsSource="{Binding SectionTypes}"
                                  SelectedValueBinding="{Binding Id}"
                                  SelectedValue="{Binding SelectedSectionTypeId}"
                                  DisplayMemberBinding="{Binding Name}"
                                  FontSize="11"
                                  HorizontalAlignment="Stretch" />
                    </StackPanel>
                </Grid>

                <!-- Fields below Course+Code are disabled until course and unique code are committed -->
                <StackPanel IsEnabled="{Binding AreOtherFieldsEnabled}" Spacing="0">

                <!-- Schedule -->
                <TextBlock Text="Schedule" FontSize="10" FontWeight="SemiBold" Foreground="{StaticResource TextLabel}" Margin="0,2,0,0" />
                <ItemsControl ItemsSource="{Binding Meetings}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="{x:Type vm:SectionMeetingViewModel}">
                            <Border BorderBrush="{StaticResource SubduedBorder}" BorderThickness="1" CornerRadius="3"
                                    Padding="5,4" Margin="0,0,0,4">

                                <!-- Columns: Day=90, Len=60, Start=60, MtgType=70, Room=*, ✕=24 -->
                                <Grid ColumnDefinitions="90,90,90,90,90,24" RowDefinitions="Auto,Auto">

                                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Day"    FontSize="9" Foreground="{StaticResource TextMuted}" Margin="0,0,2,1" />
                                    <TextBlock Grid.Row="0" Grid.Column="1" Text="Length" FontSize="9" Foreground="{StaticResource TextMuted}" Margin="2,0,2,1" />
                                    <TextBlock Grid.Row="0" Grid.Column="2" Text="Start"  FontSize="9" Foreground="{StaticResource TextMuted}" Margin="2,0,2,1" />
                                    <!-- "Mtg Type" stacked -->
                                    <StackPanel Grid.Row="0" Grid.Column="3" Orientation="Vertical" Spacing="0" Margin="2,0,2,1">
                                        <TextBlock Text="Mtg"  FontSize="9" Foreground="{StaticResource TextMuted}" LineHeight="10" />
                                        <TextBlock Text="Type" FontSize="9" Foreground="{StaticResource TextMuted}" LineHeight="10" />
                                    </StackPanel>
                                    <TextBlock Grid.Row="0" Grid.Column="4" Text="Room"   FontSize="9" Foreground="{StaticResource TextMuted}" Margin="2,0,2,1" />

                                    <!-- Day -->
                                    <ComboBox Grid.Row="1" Grid.Column="0"
                                              ItemsSource="{Binding AvailableDays}"
                                              SelectedValueBinding="{Binding Day}"
                                              SelectedValue="{Binding SelectedDay}"
                                              FontSize="11" Padding="3,1"
                                              Margin="0,0,2,0"
                                              HorizontalAlignment="Stretch">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate DataType="{x:Type vm:DayOption}">
                                                <TextBlock Text="{Binding Name}" FontSize="11" />
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>

                                    <!-- Length -->
                                    <ComboBox Grid.Row="1" Grid.Column="1"
                                              ItemsSource="{Binding AvailableBlockLengths}"
                                              SelectedItem="{Binding SelectedBlockLength}"
                                              PlaceholderText="—"
                                              FontSize="11" Padding="3,1"
                                              Margin="2,0,2,0"
                                              HorizontalAlignment="Stretch" />

                                    <!-- Start -->
                                    <ComboBox Grid.Row="1" Grid.Column="2"
                                              ItemsSource="{Binding AvailableStartTimes}"
                                              SelectedItem="{Binding SelectedStartTime}"
                                              PlaceholderText="—"
                                              FontSize="11" Padding="3,1"
                                              Margin="2,0,2,0"
                                              HorizontalAlignment="Stretch">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Converter={StaticResource MinutesToTimeConverter}}" FontSize="11" />
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>

                                    <!-- Meeting Type -->
                                    <ComboBox Grid.Row="1" Grid.Column="3"
                                              ItemsSource="{Binding MeetingTypes}"
                                              SelectedValueBinding="{Binding Id}"
                                              SelectedValue="{Binding SelectedMeetingTypeId}"
                                              DisplayMemberBinding="{Binding Name}"
                                              FontSize="11" Padding="3,1"
                                              Margin="2,0,2,0"
                                              HorizontalAlignment="Stretch" />

                                    <!-- Room -->
                                    <ComboBox Grid.Row="1" Grid.Column="4"
                                              ItemsSource="{Binding Rooms}"
                                              SelectedValueBinding="{Binding Id}"
                                              SelectedValue="{Binding SelectedRoomId}"
                                              FontSize="11" Padding="3,1"
                                              Margin="2,0,2,0"
                                              HorizontalAlignment="Stretch">
                                        <ComboBox.ItemTemplate>
                                            <DataTemplate DataType="{x:Type models:Room}">
                                                <TextBlock FontSize="11">
                                                    <TextBlock.Text>
                                                        <MultiBinding StringFormat="{}{0} {1}">
                                                            <Binding Path="Building" />
                                                            <Binding Path="RoomNumber" />
                                                        </MultiBinding>
                                                    </TextBlock.Text>
                                                </TextBlock>
                                            </DataTemplate>
                                        </ComboBox.ItemTemplate>
                                    </ComboBox>

                                    <!-- Remove button -->
                                    <Button Grid.Row="1" Grid.Column="5"
                                            Content="✕"
                                            Command="{Binding $parent[ItemsControl].DataContext.RemoveMeetingCommand}"
                                            CommandParameter="{Binding}"
                                            FontSize="10"
                                            Margin="2,0,0,0"
                                            Padding="3,2"
                                            ToolTip.Tip="Remove" />
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>

                <StackPanel Orientation="Horizontal" Spacing="4" Margin="0,2,0,0" IsEnabled="{Binding AreOtherFieldsEnabled}">
                    <Button Content="+ meeting" Command="{Binding AddMeetingCommand}" FontSize="10" Padding="4,2" />
                    <Button Content="{Binding Pattern1Label}"
                            Command="{Binding ApplyPattern1Command}"
                            IsVisible="{Binding HasPattern1}"
                            FontSize="10" Padding="4,2"
                            ToolTip.Tip="Apply Pattern 1" />
                    <Button Content="{Binding Pattern2Label}"
                            Command="{Binding ApplyPattern2Command}"
                            IsVisible="{Binding HasPattern2}"
                            FontSize="10" Padding="4,2"
                            ToolTip.Tip="Apply Pattern 2" />
                    <Button Content="{Binding Pattern3Label}"
                            Command="{Binding ApplyPattern3Command}"
                            IsVisible="{Binding HasPattern3}"
                            FontSize="10" Padding="4,2"
                            ToolTip.Tip="Apply Pattern 3" />
                    <Button Content="{Binding Pattern4Label}"
                            Command="{Binding ApplyPattern4Command}"
                            IsVisible="{Binding HasPattern4}"
                            FontSize="10" Padding="4,2"
                            ToolTip.Tip="Apply Pattern 4" />
                    <Button Content="{Binding Pattern5Label}"
                            Command="{Binding ApplyPattern5Command}"
                            IsVisible="{Binding HasPattern5}"
                            FontSize="10" Padding="4,2"
                            ToolTip.Tip="Apply Pattern 5" />
                </StackPanel>

                <!-- Instructor + Tags side by side -->
                <Grid ColumnDefinitions="*,4,*" Margin="0,4,0,0" HorizontalAlignment="Left" MaxWidth="400">

                    <!-- Left: Instructor multi-select popup -->
                    <StackPanel Grid.Column="0">
                        <TextBlock Text="Instructor(s)" FontSize="10" FontWeight="SemiBold" Foreground="{StaticResource TextLabel}" Margin="0,0,0,1" />
                        <Panel>
                            <ToggleButton x:Name="InstructorToggle"
                                          Classes="EditorPopupTrigger"
                                          Content="{Binding InstructorSummary}" />
                            <Popup PlacementTarget="{Binding #InstructorToggle}"
                                   Placement="Bottom"
                                   IsOpen="{Binding #InstructorToggle.IsChecked, Mode=TwoWay}"
                                   IsLightDismissEnabled="True">
                                <Border Background="{StaticResource FilterExpanderContent}"
                                        BorderBrush="{StaticResource SubduedBorder}"
                                        BorderThickness="1" CornerRadius="3"
                                        Padding="2" MaxHeight="160" MinWidth="160">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <ItemsControl ItemsSource="{Binding InstructorSelections}" Margin="2">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="{x:Type vm:InstructorSelectionViewModel}">
                                                    <Grid ColumnDefinitions="Auto,*,Auto" Margin="2,1,2,1">
                                                        <CheckBox Grid.Column="0"
                                                                  IsChecked="{Binding IsSelected}"
                                                                  Content="{Binding DisplayName}"
                                                                  FontSize="11"
                                                                  Padding="2,1"
                                                                  VerticalAlignment="Center" />
                                                        <TextBox Grid.Column="2"
                                                                 Text="{Binding WorkloadText}"
                                                                 Width="36"
                                                                 FontSize="11"
                                                                 Height="22"
                                                                 Padding="3,1"
                                                                 IsVisible="{Binding IsSelected}"
                                                                 Watermark="1"
                                                                 TextAlignment="Center"
                                                                 Margin="3,0,0,0"
                                                                 VerticalAlignment="Center" />
                                                    </Grid>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Panel>
                    </StackPanel>

                    <!-- Right: Tags popup -->
                    <StackPanel Grid.Column="2">
                        <TextBlock Text="Tags" FontSize="10" FontWeight="SemiBold" Foreground="{StaticResource TextLabel}" Margin="0,0,0,1" />
                        <Panel>
                            <ToggleButton x:Name="TagsToggle"
                                          Classes="EditorPopupTrigger"
                                          Content="{Binding TagSummary}" />
                            <Popup PlacementTarget="{Binding #TagsToggle}"
                                   Placement="Bottom"
                                   IsOpen="{Binding #TagsToggle.IsChecked, Mode=TwoWay}"
                                   IsLightDismissEnabled="True">
                                <Border Background="{StaticResource FilterExpanderContent}"
                                        BorderBrush="{StaticResource SubduedBorder}"
                                        BorderThickness="1" CornerRadius="3"
                                        Padding="2" MaxHeight="160" MinWidth="140">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <ItemsControl ItemsSource="{Binding TagSelections}" Margin="2">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="{x:Type vm:TagSelectionViewModel}">
                                                    <CheckBox IsChecked="{Binding IsSelected}"
                                                              Content="{Binding Value.Name}"
                                                              FontSize="11"
                                                              Padding="2,1"
                                                              Margin="2,0,0,1" />
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Panel>
                    </StackPanel>

                </Grid>

                <!-- Reserve Codes + Resources side by side -->
                <Grid ColumnDefinitions="*,4,*" Margin="0,4,0,0" HorizontalAlignment="Left" MaxWidth="400">

                    <!-- Left: Reserve Codes popup -->
                    <StackPanel Grid.Column="0">
                        <TextBlock Text="Reserve Codes" FontSize="10" FontWeight="SemiBold" Foreground="{StaticResource TextLabel}" Margin="0,0,0,1" />
                        <Panel>
                            <ToggleButton x:Name="ReservesToggle"
                                          Classes="EditorPopupTrigger"
                                          Content="{Binding ReserveSummary}" />
                            <Popup PlacementTarget="{Binding #ReservesToggle}"
                                   Placement="Bottom"
                                   IsOpen="{Binding #ReservesToggle.IsChecked, Mode=TwoWay}"
                                   IsLightDismissEnabled="True">
                                <Border Background="{StaticResource FilterExpanderContent}"
                                        BorderBrush="{StaticResource SubduedBorder}"
                                        BorderThickness="1" CornerRadius="3"
                                        Padding="2" MaxHeight="180" MinWidth="160">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <ItemsControl ItemsSource="{Binding ReserveSelections}" Margin="2">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="{x:Type vm:ReserveSelectionViewModel}">
                                                    <Grid ColumnDefinitions="Auto,*,Auto" Margin="2,1,2,1">
                                                        <CheckBox Grid.Column="0"
                                                                  IsChecked="{Binding IsSelected}"
                                                                  Content="{Binding Value.Name}"
                                                                  FontSize="11"
                                                                  Padding="2,1"
                                                                  VerticalAlignment="Center" />
                                                        <TextBox Grid.Column="2"
                                                                 Text="{Binding CodeText}"
                                                                 Width="44"
                                                                 FontSize="11"
                                                                 Height="22"
                                                                 Padding="3,1"
                                                                 IsVisible="{Binding IsSelected}"
                                                                 Watermark="#"
                                                                 TextAlignment="Center"
                                                                 Margin="6,0,0,0"
                                                                 VerticalAlignment="Center" />
                                                    </Grid>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Panel>
                    </StackPanel>

                    <!-- Right: Resources popup -->
                    <StackPanel Grid.Column="2">
                        <TextBlock Text="Resources" FontSize="10" FontWeight="SemiBold" Foreground="{StaticResource TextLabel}" Margin="0,0,0,1" />
                        <Panel>
                            <ToggleButton x:Name="ResourcesToggle"
                                          Classes="EditorPopupTrigger"
                                          Content="{Binding ResourceSummary}" />
                            <Popup PlacementTarget="{Binding #ResourcesToggle}"
                                   Placement="Bottom"
                                   IsOpen="{Binding #ResourcesToggle.IsChecked, Mode=TwoWay}"
                                   IsLightDismissEnabled="True">
                                <Border Background="{StaticResource FilterExpanderContent}"
                                        BorderBrush="{StaticResource SubduedBorder}"
                                        BorderThickness="1" CornerRadius="3"
                                        Padding="2" MaxHeight="160" MinWidth="140">
                                    <ScrollViewer VerticalScrollBarVisibility="Auto">
                                        <ItemsControl ItemsSource="{Binding ResourceSelections}" Margin="2">
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate DataType="{x:Type vm:ResourceSelectionViewModel}">
                                                    <CheckBox IsChecked="{Binding IsSelected}"
                                                              Content="{Binding Value.Name}"
                                                              FontSize="11"
                                                              Padding="2,1"
                                                              Margin="2,0,0,1" />
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </ScrollViewer>
                                </Border>
                            </Popup>
                        </Panel>
                    </StackPanel>

                </Grid>

                <!-- Notes (at bottom) -->
                <TextBlock Text="Notes" FontSize="10" Foreground="{StaticResource TextLabel}" Margin="0,4,0,0" />
                <TextBox Text="{Binding Notes}" FontSize="11" AcceptsReturn="True" Height="44" Padding="4,2" />

                </StackPanel>
                <!-- End AreOtherFieldsEnabled gate -->

                <!-- Save / Cancel (bottom) -->
                <StackPanel Orientation="Horizontal" Spacing="6" Margin="0,6,0,0">
                    <Button Content="Save"   Command="{Binding SaveCommand}"   FontSize="11" Padding="8,3" />
                    <Button Content="Cancel" Command="{Binding CancelCommand}" FontSize="11" Padding="8,3" />
                </StackPanel>

            </StackPanel>
        </DataTemplate>
    </UserControl.Resources>

    <Grid RowDefinitions="Auto,*">

        <!-- Error banner (only visible when LastErrorMessage is set) -->
        <Border Grid.Row="0"
                IsVisible="{Binding LastErrorMessage, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                Background="{StaticResource ErrorBannerBackground}" BorderBrush="{StaticResource ErrorBannerBorder}" BorderThickness="0,0,0,1"
                Padding="6,3">
            <DockPanel>
                <Button DockPanel.Dock="Right"
                        Content="✕"
                        Command="{Binding DismissErrorCommand}"
                        Background="Transparent" BorderThickness="0"
                        Padding="3,1" FontSize="10"
                        ToolTip.Tip="Dismiss" />
                <TextBlock Text="{Binding LastErrorMessage}"
                           FontSize="10" Foreground="{StaticResource ErrorBannerText}"
                           VerticalAlignment="Center"
                           TextWrapping="Wrap" />
            </DockPanel>
        </Border>

    <ScrollViewer x:Name="ListScrollViewer" Grid.Row="1">
        <StackPanel>

            <ListBox ItemsSource="{Binding SectionItems}"
                     SelectedItem="{Binding SelectedItem}"
                     x:Name="SectionListBox"
                     SelectionMode="Single"
                     Background="Transparent"
                     BorderThickness="0">
                <ListBox.ItemContainerTheme>
                    <ControlTheme TargetType="ListBoxItem" BasedOn="{StaticResource {x:Type ListBoxItem}}">
                        <Setter Property="Padding" Value="0" />
                        <Setter Property="HorizontalContentAlignment" Value="Stretch" />
                    </ControlTheme>
                </ListBox.ItemContainerTheme>
                <ListBox.ItemTemplate>
                    <DataTemplate DataType="{x:Type vm:SectionListItemViewModel}">
                        <Border BorderBrush="{StaticResource ItemSeparator}" BorderThickness="0,0,0,1">
                            <StackPanel>

                                <!-- Summary row (always visible) -->
                                <Grid ColumnDefinitions="Auto,*" Margin="2,4,6,4">
                                    <!-- Collapse/expand toggle -->
                                    <Button Grid.Column="0"
                                            Command="{Binding ToggleCollapsedCommand}"
                                            Background="Transparent" BorderThickness="0"
                                            Padding="2,0" MinWidth="0" MinHeight="0"
                                            VerticalAlignment="Top" Margin="0,1,2,0"
                                            Cursor="Hand">
                                        <Panel>
                                            <TextBlock Text="▶" FontSize="8" Foreground="{StaticResource TextLabel}"
                                                       IsVisible="{Binding IsCollapsed}" />
                                            <TextBlock Text="▼" FontSize="8" Foreground="{StaticResource TextLabel}"
                                                       IsVisible="{Binding !IsCollapsed}" />
                                        </Panel>
                                    </Button>
                                    <StackPanel Grid.Column="1" Spacing="1">
                                        <TextBlock Text="{Binding Heading}" FontWeight="SemiBold" FontSize="12" />
                                        <Grid ColumnDefinitions="Auto,8,*"
                                              IsVisible="{Binding !IsCollapsed}">
                                            <!-- Left: schedule lines -->
                                            <ItemsControl Grid.Column="0" ItemsSource="{Binding ScheduleLines}">
                                                <ItemsControl.ItemTemplate>
                                                    <DataTemplate>
                                                        <TextBlock Text="{Binding}" FontSize="11" Foreground="{StaticResource TextFaint}" />
                                                    </DataTemplate>
                                                </ItemsControl.ItemTemplate>
                                            </ItemsControl>
                                            <!-- Right: property stack -->
                                            <StackPanel Grid.Column="2" Spacing="0">
                                                <TextBlock Text="{Binding InstructorLine}" FontSize="11" Foreground="{StaticResource TextSecondary}"
                                                           IsVisible="{Binding InstructorLine, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                                           TextTrimming="CharacterEllipsis" />
                                                <TextBlock Text="{Binding TagLine}" FontSize="11" Foreground="{StaticResource TextSecondary}"
                                                           IsVisible="{Binding TagLine, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                                           TextTrimming="CharacterEllipsis" />
                                                <TextBlock Text="{Binding ReserveLine}" FontSize="11" Foreground="{StaticResource TextSecondary}"
                                                           IsVisible="{Binding ReserveLine, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                                           TextTrimming="CharacterEllipsis" />
                                                <TextBlock Text="{Binding ResourceLine}" FontSize="11" Foreground="{StaticResource TextSecondary}"
                                                           IsVisible="{Binding ResourceLine, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                                           TextTrimming="CharacterEllipsis" />
                                                <TextBlock Text="{Binding NoteLine}" FontSize="11" Foreground="{StaticResource TextSecondary}"
                                                           IsVisible="{Binding NoteLine, Converter={x:Static StringConverters.IsNotNullOrEmpty}}"
                                                           TextTrimming="CharacterEllipsis" MaxLines="1" />
                                            </StackPanel>
                                        </Grid>
                                    </StackPanel>
                                </Grid>

                                <!-- Inline edit form — shown when this item IsExpanded -->
                                <Border IsVisible="{Binding IsExpanded}"
                                        Background="{StaticResource EditorBackground}"
                                        BorderBrush="{StaticResource EditorBorder}" BorderThickness="3,0,0,0"
                                        Padding="8,6,6,8">
                                    <ContentControl Content="{Binding $parent[UserControl].DataContext.EditVm}"
                                                    ContentTemplate="{StaticResource InlineEditFormTemplate}" />
                                </Border>

                            </StackPanel>
                        </Border>
                    </DataTemplate>
                </ListBox.ItemTemplate>
            </ListBox>

        </StackPanel>
    </ScrollViewer>

    </Grid>

</UserControl>
