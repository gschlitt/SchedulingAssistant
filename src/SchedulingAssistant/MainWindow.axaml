<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:SchedulingAssistant.ViewModels"
        xmlns:views="using:SchedulingAssistant.Views.Management"
        xmlns:gridViews="using:SchedulingAssistant.Views.GridView"
        xmlns:controls="using:SchedulingAssistant.Controls"
        x:Class="SchedulingAssistant.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        x:CompileBindings="False"
        Title="Scheduling Assistant"
        Width="1400" Height="800"
        MinWidth="900" MinHeight="600">

    <Grid RowDefinitions="Auto,*">

        <!-- Top menu bar -->
        <Border Grid.Row="0" Background="{StaticResource ChromeBackground}" Padding="12,0"
                BorderBrush="{StaticResource ChromeBorder}" BorderThickness="0,0,0,1">
            <DockPanel>

                <!-- Semester picker, right-aligned -->
                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" Spacing="8"
                            VerticalAlignment="Center" Margin="8,0">
                    <Border Width="1" Background="{StaticResource SeparatorLine}" Margin="0,6" />
                    <TextBlock Text="Semester:" Foreground="{StaticResource TextSemesterLabel}" FontSize="12"
                               VerticalAlignment="Center" />
                    <ComboBox ItemsSource="{Binding SemesterContext.SemesterDisplays}"
                              SelectedItem="{Binding SemesterContext.SelectedSemesterDisplay}"
                              DisplayMemberBinding="{Binding DisplayName}"
                              MinWidth="220"
                              VerticalAlignment="Center" />
                </StackPanel>

                <!-- Nav buttons, left-aligned -->
                <StackPanel Orientation="Horizontal" Spacing="4" VerticalAlignment="Center">

                    <!-- Files menu (far left) -->
                    <Menu Background="Transparent" VerticalAlignment="Center">
                        <MenuItem Header="Files" Classes="nav" Padding="14,8">
                            <MenuItem Header="Open…" Command="{Binding OpenDatabaseCommand}" />
                            <MenuItem Header="New…" Command="{Binding NewDatabaseCommand}" />
                            <Separator IsVisible="{Binding RecentDatabases.Count}" />
                            <MenuItem Header="Recent Files"
                                      IsVisible="{Binding RecentDatabases.Count}"
                                      ItemsSource="{Binding RecentDatabases}">
                                <MenuItem.ItemTemplate>
                                    <DataTemplate>
                                        <MenuItem Header="{Binding DisplayName}"
                                                  Command="{Binding DataContext.OpenRecentDatabaseCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                  CommandParameter="{Binding Path}" />
                                    </DataTemplate>
                                </MenuItem.ItemTemplate>
                            </MenuItem>
                        </MenuItem>
                    </Menu>

                    <Border Width="1" Background="{StaticResource SeparatorLine}" Margin="0,6,8,6" />

                    <TextBlock Text="{Binding DatabaseName}"
                               FontWeight="SemiBold" FontSize="13"
                               VerticalAlignment="Center"
                               Margin="4,0,8,0" />
                    <Border Width="1" Background="{StaticResource SeparatorLine}" Margin="0,6,8,6" />
                    <Button Content="Subjects" Command="{Binding NavigateToSubjectsCommand}" Classes="nav" />
                    <Button Content="Courses" Command="{Binding NavigateToCoursesCommand}" Classes="nav" />
                    <Button Content="Instructors" Command="{Binding NavigateToInstructorsCommand}" Classes="nav" />
                    <Button Content="Rooms" Command="{Binding NavigateToRoomsCommand}" Classes="nav" />
                    <Button Content="Section Properties" Command="{Binding NavigateToSectionPropertiesCommand}" Classes="nav" />

                    <Border Width="1" Background="{StaticResource SeparatorLine}" Margin="8,6" />

                    <Button Content="Academic Years" Command="{Binding NavigateToAcademicYearsCommand}" Classes="nav" />

                    <Border Width="1" Background="{StaticResource SeparatorLine}" Margin="8,6" />

                    <!-- Settings dropdown menu -->
                    <Menu Background="Transparent" VerticalAlignment="Center">
                        <MenuItem Header="Settings" Classes="nav" Padding="14,8">
                            <MenuItem Header="Scheduling"
                                      Command="{Binding NavigateToBlockLengthsCommand}" />
                            <MenuItem Header="Block Patterns"
                                      Command="{Binding NavigateToBlockPatternsCommand}" />
                        </MenuItem>
                    </Menu>

                    <!-- Debug menu (added in code-behind in DEBUG mode) -->
                    <Menu x:Name="DebugMenu" Background="Transparent" VerticalAlignment="Center" IsVisible="False">
                        <MenuItem Header="Debug" Classes="nav" Padding="14,8">
                            <MenuItem Header="Debug View…"
                                      Command="{Binding OpenDebugCommand}" />
                        </MenuItem>
                    </Menu>
                </StackPanel>

            </DockPanel>
        </Border>

        <!-- Main body: layered panel (permanent grid beneath, flyout overlay above) -->
        <Panel Grid.Row="1">

            <!-- Layer 0: permanent three-panel grid -->
            <Grid x:Name="ThreePanelGrid" ColumnDefinitions="220,4,*">

                <!-- Left column: Section Editor (top) + Workload (bottom) -->
                <Grid Grid.Column="0" RowDefinitions="*,4,200">

                    <!-- Section Editor slot (detachable) -->
                    <controls:DetachablePanel Grid.Row="0"
                                              x:Name="SectionEditorPanel"
                                              Header="Sections"
                                              DetachRequested="OnSectionEditorDetach">
                        <controls:DetachablePanel.HeaderExtra>
                            <StackPanel Orientation="Horizontal" Spacing="3"
                                        DataContext="{Binding SectionListVm}">
                                <Button Content="▼" ToolTip.Tip="Expand all cards"
                                        Command="{Binding ExpandAllCommand}"
                                        FontSize="9" Padding="4,1"
                                        MinHeight="0" MinWidth="0"
                                        Background="Transparent" BorderThickness="0" />
                                <Button Content="▶" ToolTip.Tip="Collapse all cards"
                                        Command="{Binding CollapseAllCommand}"
                                        FontSize="9" Padding="4,1"
                                        MinHeight="0" MinWidth="0"
                                        Background="Transparent" BorderThickness="0" />
                                <Border Width="1" Background="{StaticResource SeparatorLine}" Margin="2,2" />
                                <Button Content="Add"
                                        Command="{Binding AddCommand}"
                                        FontSize="10" Padding="5,1"
                                        MinHeight="0" MinWidth="0" />
                                <Button Content="Edit"
                                        Command="{Binding EditCommand}"
                                        IsEnabled="{Binding SelectedItem, Converter={x:Static ObjectConverters.IsNotNull}}"
                                        FontSize="10" Padding="5,1"
                                        MinHeight="0" MinWidth="0" />
                                <Button Content="Copy"
                                        Command="{Binding CopyCommand}"
                                        IsEnabled="{Binding SelectedItem, Converter={x:Static ObjectConverters.IsNotNull}}"
                                        FontSize="10" Padding="5,1"
                                        MinHeight="0" MinWidth="0" />
                                <Button Content="Delete"
                                        Command="{Binding DeleteCommand}"
                                        IsEnabled="{Binding SelectedItem, Converter={x:Static ObjectConverters.IsNotNull}}"
                                        FontSize="10" Padding="5,1"
                                        MinHeight="0" MinWidth="0" />
                            </StackPanel>
                        </controls:DetachablePanel.HeaderExtra>
                        <controls:DetachablePanel.PanelContent>
                            <views:SectionListView DataContext="{Binding SectionListVm}" />
                        </controls:DetachablePanel.PanelContent>
                    </controls:DetachablePanel>

                    <GridSplitter Grid.Row="1" ResizeDirection="Rows" Height="4"
                                  HorizontalAlignment="Stretch" Background="{StaticResource GridSplitterColor}" />

                    <!-- Workload slot (detachable, placeholder) -->
                    <controls:DetachablePanel Grid.Row="2"
                                              x:Name="WorkloadPanel"
                                              Header="Workload"
                                              DetachRequested="OnWorkloadDetach">
                        <controls:DetachablePanel.PanelContent>
                            <TextBlock Text="Workload View (coming soon)"
                                       HorizontalAlignment="Center" VerticalAlignment="Center"
                                       Foreground="{StaticResource TextMuted}" FontSize="12" />
                        </controls:DetachablePanel.PanelContent>
                    </controls:DetachablePanel>

                </Grid>

                <!-- Column splitter -->
                <GridSplitter Grid.Column="1" ResizeDirection="Columns" Width="4"
                              VerticalAlignment="Stretch" Background="{StaticResource GridSplitterColor}" />

                <!-- Right column: Schedule Grid (permanent, detachable) -->
                <controls:DetachablePanel Grid.Column="2"
                                          x:Name="ScheduleGridPanel"
                                          Header="Schedule View"
                                          DetachRequested="OnScheduleGridDetach">
                    <controls:DetachablePanel.HeaderContext>
                        <StackPanel Orientation="Horizontal" Spacing="6" VerticalAlignment="Center">

                            <!-- Semester -->
                            <Border Width="1" Background="{StaticResource SeparatorLine}" Margin="0,3" />
                            <TextBlock Text="{Binding ScheduleGridVm.SemesterLine}"
                                       FontSize="12"
                                       VerticalAlignment="Center" />

                            <!-- Subject filter (only shown when active) -->
                            <Border Width="1" Background="{StaticResource SeparatorLine}" Margin="0,3"
                                    IsVisible="{Binding ScheduleGridVm.SubjectFilterSummary, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                            <TextBlock Text="{Binding ScheduleGridVm.SubjectFilterSummary}"
                                       FontSize="12"
                                       VerticalAlignment="Center"
                                       IsVisible="{Binding ScheduleGridVm.SubjectFilterSummary, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />

                            <!-- Stats (always shown) -->
                            <Border Width="1" Background="{StaticResource SeparatorLine}" Margin="0,3"
                                    IsVisible="{Binding ScheduleGridVm.StatsLine, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />
                            <TextBlock Text="{Binding ScheduleGridVm.StatsLine}"
                                       FontSize="12"
                                       VerticalAlignment="Center"
                                       IsVisible="{Binding ScheduleGridVm.StatsLine, Converter={x:Static StringConverters.IsNotNullOrEmpty}}" />

                            <!-- Filtered by (only shown when filter active) -->
                            <Border Width="1" Background="{StaticResource SeparatorLine}" Margin="0,3"
                                    IsVisible="{Binding ScheduleGridVm.Filter.IsActive}" />
                            <TextBlock Text="Filtered by:"
                                       FontSize="12"
                                       FontWeight="Bold"
                                       Foreground="{StaticResource FilterBadgeText}"
                                       VerticalAlignment="Center"
                                       IsVisible="{Binding ScheduleGridVm.Filter.IsActive}" />
                            <TextBlock Text="{Binding ScheduleGridVm.Filter.ActiveSummary}"
                                       FontSize="12"
                                       FontWeight="Bold"
                                       Foreground="{StaticResource FilterBadgeText}"
                                       VerticalAlignment="Center"
                                       TextTrimming="CharacterEllipsis"
                                       MaxWidth="400"
                                       IsVisible="{Binding ScheduleGridVm.Filter.IsActive}" />

                        </StackPanel>
                    </controls:DetachablePanel.HeaderContext>
                    <controls:DetachablePanel.PanelContent>
                        <gridViews:ScheduleGridView DataContext="{Binding ScheduleGridVm}" />
                    </controls:DetachablePanel.PanelContent>
                </controls:DetachablePanel>

            </Grid>

            <!-- Layer 1: management flyout overlay -->
            <Panel IsVisible="{Binding FlyoutPage, Converter={x:Static ObjectConverters.IsNotNull}}">

                <!-- Dim backdrop — clicking it closes the flyout -->
                <Border Background="{StaticResource FlyoutScrim}"
                        PointerPressed="OnFlyoutBackdropPressed" />

                <!-- Flyout panel (drops from top) -->
                <Border VerticalAlignment="Top"
                        HorizontalAlignment="Stretch"
                        MaxHeight="650"
                        Background="{StaticResource FlyoutBackground}"
                        BoxShadow="0 4 20 2 #50000000"
                        CornerRadius="0,0,6,6"
                        Margin="8,0,8,0">
                    <Grid RowDefinitions="Auto,*">

                        <!-- Flyout header -->
                        <Border Grid.Row="0" Background="{StaticResource FlyoutHeaderBackground}"
                                BorderBrush="{StaticResource FlyoutHeaderBorder}" BorderThickness="0,0,0,1"
                                Padding="16,10">
                            <DockPanel>
                                <Button DockPanel.Dock="Right"
                                        Content="✕"
                                        Command="{Binding CloseFlyoutCommand}"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Padding="8,4"
                                        FontSize="14" />
                                <TextBlock Text="{Binding FlyoutTitle}"
                                           FontWeight="SemiBold"
                                           FontSize="15"
                                           VerticalAlignment="Center" />
                            </DockPanel>
                        </Border>

                        <!-- Flyout content (scrollable) -->
                        <ScrollViewer Grid.Row="1">
                            <ContentControl Content="{Binding FlyoutPage}" Margin="16" />
                        </ScrollViewer>

                    </Grid>
                </Border>

            </Panel>

        </Panel>

    </Grid>
</Window>
